<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Gandhinagar + Ahmedabad Metro Navigator</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200&display=swap" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<style>
  body,html{margin:0;padding:0;}
  #map{height:60vh;width:100%;}
  .chip{white-space:nowrap;padding:6px 16px;border-radius:9999px;font-size:12px;background:#e5e7eb;color:#334155;cursor:pointer;}
  .chip:hover{background:#0d7ff2;color:white;}
</style>
</head>
<body class="bg-black text-white flex flex-col min-h-screen">

<header class="p-4 bg-neutral-900 border-b border-neutral-700">
  <h1 class="text-xl font-bold flex items-center gap-2">
    <span class="material-symbols-outlined text-blue-500">tram</span>
    GN + AH Metro Navigator
  </h1>

  <div class="mt-3 relative">
    <input id="srcInput" placeholder="Your location"
           class="w-full p-2 rounded bg-neutral-800 border border-neutral-600 mb-2"/>
    <input id="dstInput" placeholder="Where to?"
           class="w-full p-2 rounded bg-neutral-800 border border-neutral-600"/>

    <button id="swapBtn"
      class="absolute right-2 top-8 bg-blue-500 text-white px-3 py-1 rounded-full">swap</button>
  </div>

  <div class="flex gap-2 overflow-x-auto mt-2">
    <button class="chip">Thaltej</button>
    <button class="chip">Apparel Park</button>
    <button class="chip">Motera</button>
    <button class="chip">Infocity</button>
  </div>
</header>

<main class="flex-1 relative">
  <div id="map"></div>

  <button id="gpsBtn"
    class="absolute bottom-24 right-4 p-3 bg-blue-600 text-white rounded-full shadow-xl">
    <span class="material-symbols-outlined">my_location</span>
  </button>

  <button id="refreshBtn"
    class="absolute bottom-24 left-4 p-3 bg-gray-700 text-white rounded-full shadow-xl">
    <span class="material-symbols-outlined">refresh</span>
  </button>
</main>

<footer class="bg-neutral-900 p-4 border-t border-neutral-700">
  <p class="text-xs text-blue-400 font-semibold uppercase">Nearest Metro</p>
  <h2 id="nearestStationName" class="text-lg font-bold">Detecting...</h2>
  <p id="nearestStationLine" class="text-sm text-neutral-400">â€”</p>
</footer>
<script>
// ---------- MAP INIT ---------- //
let map = L.map("map").setView([23.06,72.6],12);
L.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

// ---------- GLOBAL ---------- //
let stations = [];
let userMarker = null;
let trackLayers = [];
let routeLine = null;

// ---------- USER ICON (RED) ---------- //
const userIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize:[28,28],iconAnchor:[14,28]
});

// ---------- LOAD METRO STATIONS (dynamic subway stations only) ---------- //
async function loadStations(){
  const query = `
  [out:json];
  node["station"="subway"](22.90,72.40,23.40,72.80);
  out center;`;

  const res = await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
  const data = await res.json();

  stations = data.elements.map(e=>({name:e.tags.name, lat:e.lat, lng:e.lon}));

  stations.forEach(s=>{
    const m=L.marker([s.lat,s.lng]).addTo(map).bindPopup(`<b>${s.name}</b>`);
    // clicking station routes along tracks
    m.on("click",()=>routeFromUserToStation(s));
  });
}


// ---------- DRAW METRO TRACKS (taken from your working code) ---------- //
async function drawMetroTrack(){
  const q=`
    [out:json];
    way["railway"~"subway|light_rail|tram"](22.90,72.40,23.40,72.90);
    (._;>;);
    out;`;

  const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:q});
  const data=await res.json();

  const nodes={};
  data.elements.filter(e=>e.type==="node").forEach(n=>nodes[n.id]=[n.lat,n.lon]);

  const tracksRaw=data.elements.filter(e=>e.type==="way" && e.tags && e.tags.railway)
    .map(w=>w.nodes.map(n=>nodes[n]).filter(Boolean));

  // remove previous lines
  trackLayers.forEach(l=>map.removeLayer(l));
  trackLayers=[];

  // draw every available segment
  tracksRaw.forEach(path=>{
    const line=L.polyline(path,{color:"#0099ff",opacity:.6,weight:4}).addTo(map);
    trackLayers.push(line);
  });
}


// ---------- FIND NEAREST STATION ---------- //
function nearest(lat,lng){
  let best=null,dist=99999;
  stations.forEach(s=>{
    const d=Math.hypot(lat-s.lat,lng-s.lng);
    if(d<dist){dist=d;best=s;}
  });
  return best;
}

function findNearest(coords){
  const s=nearest(coords.lat,coords.lng);
  nearestStationName.innerText = s.name;
  nearestStationLine.innerText = "Connected Metro Station";
  drawUserRoute(coords,s);
}


// ---------- GPS ---------- //
function getGPS(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const coords={lat:pos.coords.latitude,lng:pos.coords.longitude};
    srcInput.value=`${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`;
    
    if(userMarker) map.removeLayer(userMarker);
    userMarker=L.marker([coords.lat,coords.lng],{icon:userIcon})
      .addTo(map).bindPopup("You are here").openPopup();
      
    map.setView([coords.lat,coords.lng],14);
    findNearest(coords);
  },()=>alert("Enable GPS & run HTTPS"));
}


// ---------- ROUTE ALONG TRACKS NOT STRAIGHT ---------- //
function drawUserRoute(from,to){
  if(routeLine) map.removeLayer(routeLine);

  let best=null,min=99999;

  trackLayers.forEach(layer=>{
    const pts=layer.getLatLngs();
    const d=Math.hypot(from.lat-pts[0].lat,from.lng-pts[0].lng)+
            Math.hypot(to.lat-pts[pts.length-1].lat,to.lng-pts[pts.length-1].lng);
    if(d<min){min=d;best=pts;}
  });

  if(best){
    routeLine=L.polyline(best,{color:"#ffdd00",weight:5}).addTo(map);
    map.fitBounds(routeLine.getBounds());
  }
}


// ---------- CLICK STATION ROUTING ---------- //
function routeFromUserToStation(dest){
  if(!userMarker) return alert("User not detected yet");
  const u=userMarker.getLatLng();
  drawUserRoute({lat:u.lat,lng:u.lng},dest);
}


// ---------- SEARCH ENTER ---------- //
dstInput.addEventListener("keypress",e=>{
  if(e.key==="Enter"){
    let val=dstInput.value.toLowerCase();
    let match=stations.find(s=>s.name.toLowerCase().includes(val));
    if(match && userMarker){
      let u=userMarker.getLatLng();
      drawUserRoute({lat:u.lat,lng:u.lng},match);
    }
  }
});


// ---------- CHIPS ---------- //
const chipLoc={
 "Thaltej":{lat:23.059395,lng:72.508349},
 "Apparel Park":{lat:23.019300,lng:72.634600},
 "Motera":{lat:23.092204,lng:72.596535},
 "Infocity":{lat:23.188700,lng:72.628800}
};

document.querySelectorAll(".chip").forEach(chip=>{
 chip.onclick=()=>{
   const p=chipLoc[chip.innerText.trim()];
   if(userMarker && p){
     let u=userMarker.getLatLng();
     const destStation=nearest(p.lat,p.lng);
     drawUserRoute({lat:u.lat,lng:u.lng},destStation);
   }
 };
});


// ---------- BUTTONS ---------- //
gpsBtn.onclick=getGPS;
refreshBtn.onclick=getGPS;
swapBtn.onclick=()=>[srcInput.value,dstInput.value]=[dstInput.value,srcInput.value];


// ---------- INIT ---------- //
window.onload=()=>{
  getGPS();
  loadStations();
  drawMetroTrack();
};
</script>


</body>
</html>
