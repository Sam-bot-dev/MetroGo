<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Gandhinagar + Ahmedabad Metro Navigator</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200&display=swap" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<style>
  body,html{margin:0;padding:0;}
  #map{height:60vh;width:100%;}
  .chip{white-space:nowrap;padding:6px 16px;border-radius:9999px;font-size:12px;background:#e5e7eb;color:#334155;cursor:pointer;}
  .chip:hover{background:#0d7ff2;color:white;}
</style>
</head>
<body class="bg-black text-white flex flex-col min-h-screen">

<header class="p-4 bg-neutral-900 border-b border-neutral-700">
  <h1 class="text-xl font-bold flex items-center gap-2">
    <span class="material-symbols-outlined text-blue-500">tram</span>
    GN + AH Metro Navigator
  </h1>

  <div class="mt-3 relative">
    <input id="srcInput" placeholder="Your location"
           class="w-full p-2 rounded bg-neutral-800 border border-neutral-600 mb-2"/>
    <input id="dstInput" placeholder="Where to?"
           class="w-full p-2 rounded bg-neutral-800 border border-neutral-600"/>

    <button id="swapBtn"
      class="absolute right-2 top-8 bg-blue-500 text-white px-3 py-1 rounded-full">swap</button>
  </div>

  <div class="flex gap-2 overflow-x-auto mt-2">
    <button class="chip">Thaltej</button>
    <button class="chip">Apparel Park</button>
    <button class="chip">Motera</button>
    <button class="chip">Infocity</button>
  </div>
</header>

<main class="flex-1 relative">
  <div id="map"></div>

  <button id="gpsBtn"
    class="absolute bottom-24 right-4 p-3 bg-blue-600 text-white rounded-full shadow-xl">
    <span class="material-symbols-outlined">my_location</span>
  </button>

  <button id="refreshBtn"
    class="absolute bottom-24 left-4 p-3 bg-gray-700 text-white rounded-full shadow-xl">
    <span class="material-symbols-outlined">refresh</span>
  </button>
</main>

<footer class="bg-neutral-900 p-4 border-t border-neutral-700">
  <p class="text-xs text-blue-400 font-semibold uppercase">Nearest Metro</p>
  <h2 id="nearestStationName" class="text-lg font-bold">Detecting...</h2>
  <p id="nearestStationLine" class="text-sm text-neutral-400">‚Äî</p>
</footer>

<script>
// ---------- MAP INIT ---------- //
let map=L.map("map").setView([23.06,72.6],12);
L.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

// ---------- GLOBAL ---------- //
let stations=[];
let userMarker=null;

// ---------- USER ICON ---------- //
const userIcon=L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/2776/2776067.png",
  iconSize:[36,36],iconAnchor:[18,36],popupAnchor:[0,-36]
});

// ---------- ROUTING ---------- //
let router=null;
function drawRoute(from,to){
  if(router) map.removeControl(router);
  router=L.Routing.control({
    waypoints:[L.latLng(from.lat,from.lng),L.latLng(to.lat,to.lng)],
    lineOptions:{styles:[{color:"#00ffcc",weight:4}]},
    addWaypoints:false,draggableWaypoints:false,createMarker:()=>null
  }).addTo(map);
}

// ---------- FIND NEAREST ---------- //
function findNearest(coords){
  if(stations.length===0) return;

  let nearest=null,dist=999;
  stations.forEach(s=>{
    const d=Math.hypot(coords.lat-s.lat,coords.lng-s.lng);
    if(d<dist){dist=d;nearest=s;}
  });

  document.getElementById("nearestStationName").innerText = nearest.name;
  document.getElementById("nearestStationLine").innerText = "Auto-updated from OSM";
  drawRoute(coords,nearest);
}

// ---------- GET USER GPS ---------- //
function getGPS(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const coords={lat:pos.coords.latitude,lng:pos.coords.longitude};

    // fill your location input
    srcInput.value=`${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`;

    // show user marker
    if(userMarker) map.removeLayer(userMarker);
    userMarker=L.marker([coords.lat,coords.lng],{icon:userIcon})
      .addTo(map).bindPopup("<b>You are here</b>").openPopup();

    map.setView([coords.lat,coords.lng],14);

    // if stations already loaded ‚Üí find nearest
    findNearest(coords);

  },()=>alert("Enable location permissions & run with localhost/https!"));
}

// ---------- LOAD METRO STATIONS DYNAMICALLY ---------- //
async function loadStations(){
  const query = `
  [out:json];
  (
    node["station"="subway"](22.90,72.40,23.40,72.80);
    node["railway"="station"]["subway"="yes"](22.90,72.40,23.40,72.80);
    node["railway"="halt"]["subway"="yes"](22.90,72.40,23.40,72.80);
  );
  out center;`;

  try{
    const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
    const data=await res.json();

    stations=data.elements.map(e=>({name:e.tags.name,lat:e.lat,lng:e.lon}));
    console.log(`Dynamic stations loaded:`,stations);

    // place markers
    stations.forEach(s=>{
      L.marker([s.lat,s.lng]).addTo(map)
       .bindPopup(`<b>${s.name}</b><br>Metro Station`);
    });

    // if user location known ‚Üí update nearest
    if(userMarker){
      const c=userMarker.getLatLng();
      findNearest({lat:c.lat,lng:c.lng});
    }
  }
  catch(err){
    console.error("Overpass error:",err);
  }
}

// ---------- CHIPS ---------- //
const chipLoc={
 "Thaltej":{lat:23.058850,lng:72.508086},
 "Apparel Park":{lat:23.019300,lng:72.634600},
 "Motera":{lat:23.092204,lng:72.596535},
 "Infocity":{lat:23.1887,lng:72.6288}
};
document.querySelectorAll(".chip").forEach(chip=>{
 chip.onclick=()=>{
   const p=chipLoc[chip.innerText.trim()];
   document.getElementById("dstInput").value=chip.innerText.trim();
   if(userMarker) findNearest(p);
 };
});

// ---------- BUTTONS ---------- //
gpsBtn.onclick=getGPS;
refreshBtn.onclick=getGPS;
swapBtn.onclick=()=>[srcInput.value,dstInput.value]=[dstInput.value,srcInput.value];

// ---------- INIT (FAST GPS FIRST, STATIONS IN BACKGROUND) ---------- //
window.onload=()=>{
  getGPS();        // üöÄ instant current location
  loadStations();  // üåç fetch live metro dynamically
};
</script>
</body>
</html>
